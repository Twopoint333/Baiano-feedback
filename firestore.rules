
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in (including anonymous users)
    function isSignedIn() {
      return request.auth != null;
    }

    // Rules for the survey_responses collection
    match /survey_responses/{surveyResponseId} {
      // READ: Anyone can read survey responses.
      allow get, list: if true;

      // CREATE: Any signed-in user can submit a new survey response.
      allow create: if isSignedIn();

      // UPDATE & DELETE: No client can modify or delete a survey response.
      allow update, delete: if false;
    }
    
    // Rules for the prize_claims collection
    match /prize_claims/{phoneNumber} {
      // READ: A user can check if a prize has been claimed for their phone number.
      // They must be signed in to do this check.
      allow get: if isSignedIn();
      
      // LIST: Listing all claimed prizes is disallowed for security and privacy.
      allow list: if false;

      // CREATE: A user can claim a prize (create a document) ONLY IF:
      // 1. They are signed in.
      // 2. A document with this phone number ID does not already exist.
      // This is the core security rule to prevent duplicate prize claims.
      allow create: if isSignedIn() && !exists(path);

      // UPDATE & DELETE: Once a prize is claimed, it cannot be changed or deleted by any client.
      allow update, delete: if false;
    }
  }
}
